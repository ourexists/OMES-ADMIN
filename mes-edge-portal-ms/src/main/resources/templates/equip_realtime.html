<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <link rel="stylesheet" href="../static/leaflet/leaflet.css"/>
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <script src="../static/leaflet/leaflet.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <div class="layui-col-sm12 layui-col-md4 layui-col-lg3">
        <div class="layui-card">
            <div class="layui-card-body mini-bar" id="ltTree">
                <div class="layui-inline">
                    <input type="text" id="tree_name" class="layui-input" autocomplete="off"/>
                </div>
                <a class="layui-btn layui-btn-primary" id="tree_query">
                    <i class="layui-icon layui-icon-search"></i>
                </a>
                <div id="left-tree"></div>
            </div>
        </div>
    </div>
    <div class="layui-col-sm12 layui-col-md9 layui-col-lg9" style="padding: 15px;">
        <form class="layui-form layui-row layui-col-space16">
            <div class="layui-col-md4">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <input type="text" name="name" id="name" value=""
                           class="layui-input"
                           lay-affix="clear" lang-i18n="equip.name">
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <input type="text" name="selfCode" id="selfCode"
                           lay-affix="clear" class="layui-input" lang-i18n="equip.code">
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <select name="type" id="type">
                        <option value="" lang-i18n="equip.type" selected></option>
                    </select>
                </div>
            </div>

            <div class="layui-btn-container layui-col-xs12">
                <button class="layui-btn" lay-submit lay-filter="tb-common-search" lang-i18n="common.search">
                    Search
                </button>
                <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.clear">Clear</button>
            </div>
        </form>
        <div id="map"></div>
    </div>
</div>


<script th:inline="none">
    var current_row_data;
    var selected_tree_node;
    var table;
    var tree;

    layui.use(['form', 'table', 'dropdown', 'layer', 'tree', 'util'], function () {
        table = layui.table;
        tree = layui.tree;
        var form = layui.form;

        var onlineIcon = L.icon({
            iconUrl: '/static/img/online_dev.svg',
            iconSize: [32, 32]
        });

        var offlineIcon = L.icon({
            iconUrl: '/static/img/offline_dev.svg',
            iconSize: [32, 32]
        });

        var alarmIcon = L.icon({
            iconUrl: '/static/img/alarm_dev.svg',
            iconSize: [32, 32]
        });

        let map = L.map('map').setView([32.060255, 118.796877], 6);
        let marker;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        get(router.equip_type, null, function (result) {
            $.each(result, function (index, item) {
                console.info(JSON.stringify(result))
                $('#type').append(new Option(item.name, item.id));
            })
            form.render();
        })


        get(router.workshop_tree, null, function (result) {
            tree.render({
                elem: '#left-tree',
                data: result,
                onlyIconControl: true,  // 是否仅允许节点左侧图标控制展开收缩
                id: 'left-tree',
                edit: [],
                extEdit: true,
                customName: { // 自定义 data 字段名 --- 2.8.14+
                    title: 'name',
                    field: 'selfCode'
                },
                click: function (obj) {
                    $(".layui-tree-set").removeClass('layui-tree-set-active');
                    obj.elem.addClass('layui-tree-set-active');
                    //获取当前点击的节点数据
                    selected_tree_node = obj.data;
                    reloadTb();
                }
            });
        }, function (code, msg) {
            alert("请重试");
        })


        // 搜索提交
        form.on('submit(tb-common-search)', function (data) {
            if (selected_tree_node !== null) {
                reloadTb();
            }
            return false; // 阻止默认 form 跳转
        });

        $('#tree_query').click(function () {
            var name = $("#tree_name").val(); //搜索值
            var elem = $("#left-tree").find('.layui-tree-txt').css('color', ''); //搜索文本与设置默认颜色
            if (!name) {
                return; //无搜索值返回
            }
            elem.filter(':contains(' + name + ')').css('color', '#FFB800'); //搜索文本并设置标志颜色
            elem.parents('.layui-tree-pack').prev().find('.layui-tree-iconClick').click(); //展开选项
        });

        function reloadMap(workshopCode) {
            get(router.equip_realtime_workshop, {"workshopCode": workshopCode}, function (e) {
                e.forEach(function (d) {
                    var marker = L.marker([d.lat, d.lng], {
                        icon: d.status === 'online' ? onlineIcon : offlineIcon
                    }).addTo(map);

                    marker.bindPopup(`
      <b>${d.name}</b><br/>
      设备编号：${d.selfCode}<br/>
      状态：${d.status === 'online' ? '在线' : '离线'}
    `);
                });
            })
        }
    });
</script>
</body>
</html>