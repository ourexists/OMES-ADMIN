<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/css/common.css">
    <link rel="stylesheet" href="../static/tree-select/treeSelect.css">
    <link rel="stylesheet" href="../static/fullscreen/fullscreen.css">
    <link rel="stylesheet" href="../static/leaflet/leaflet.css"/>
    <link rel="stylesheet" href="../static/marker/MarkerCluster.css"/>
    <link rel="stylesheet" href="../static/marker/MarkerCluster.Default.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <script src="../static/leaflet/leaflet.js"></script>
    <script src="../static/marker/leaflet.markercluster.js"></script>
    <script src="../static/tree-select/treeSelect.js"></script>
    <script src="../static/fullscreen/fullscreen.js"></script>
</head>
<body>
<div class="layui-tab-content main-panel oemes-container">
    <div class="layui-col-md12 right-panel">
        <form class="layui-form layui-row layui-col-space16">
            <div class="layui-col-md3">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <input type="text" name="name" id="name" value=""
                           class="layui-input"
                           lay-affix="clear" lang-i18n="equip.name">
                </div>
            </div>
            <div class="layui-col-md3">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <input type="text" name="selfCode" id="selfCode"
                           lay-affix="clear" class="layui-input" lang-i18n="equip.code">
                </div>
            </div>
            <div class="layui-col-md3">
                <div class="layui-input-wrap">
                    <div class="layui-input-prefix">
                        <i class="layui-icon layui-icon-auz"></i>
                    </div>
                    <select name="type" id="type">
                        <option value="" lang-i18n="equip.type" selected></option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md3">
                <button class="layui-btn layui-btn-sm" lay-submit lay-filter="tb-common-search"
                        lang-i18n="common.search">
                    Search
                </button>
                <button type="reset" class="layui-btn layui-btn-sm layui-btn-primary" lang-i18n="common.clear">Clear
                </button>
            </div>
        </form>
        <div id="cardContainer" class="common-data-container"></div>
    </div>
</div>

<script type="text/html" id="deviceCardTpl">
    {{# layui.each(d, function(index, item){ }}
    <div class="layui-col-md3 layui-col-sm6 device-container">
        <div class="layui-card device-card">
            <div class="layui-card-header">
                <div class="card-header-1">
                    <span>{{ item.name }}</span>
                    <span class="status-dot {{ item.onlineState==1 ? 'status-online' : 'status-offline' }}"></span>
                    <span class="status-dot {{ item.onlineState==1 ? (item.runState==1 ? 'status-running' : 'status-offline') : 'status-offline' }}"></span>
                    <span class="status-dot {{ item.onlineState==1 && item.alarmState==1 ? 'status-alarm' : 'status-offline' }}"></span>
                </div>
                {{# layui.each(item.alarmTexts, function(index, t){ }}
                <p style="color: red">{{ t }}</p>
                {{# }); }}
                <div class="card-header-2">
                    <p>{{ i18np.prop('equip.code') }}:{{ item.selfCode }}</p>
                    <p>{{ i18np.prop('workshop.name') }}:{{ item.workshop === null ? '' : item.workshop.name }}</p>
                </div>
            </div>

            <div class="layui-card-body">
                {{# layui.each(item.attrs, function(index, t){ }}
                <p>{{ t.name }} : {{t.value == null ? 'unknow' : t.value }}</p>
                {{# }); }}
            </div>

            <div class="layui-card-footer">
                <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="openEdit('{{ item.id }}')">
                    <i class="layui-icon layui-icon-edit"></i>
                </button>
                {{# if (item.attrs!=null && item.attrs.length>0) { }}
                <button class="layui-btn layui-btn-xs layui-btn-primary"
                        onclick="openAttrHistory('{{ item.selfCode }}')">
                    <i class="layui-icon layui-icon-log"></i>
                </button>
                <button class="layui-btn layui-btn-xs layui-btn-primary"
                        onclick="openCollectEcharts('{{ item.selfCode }}')">
                    <i class="layui-icon layui-icon-chart"></i>
                </button>
                {{# } }}
                <button class="layui-btn layui-btn-xs layui-btn-primary"
                        onclick="openRunEcharts('{{ item.selfCode }}')">
                    <i class="layui-icon layui-icon-engine"></i>
                </button>
            </div>
        </div>
    </div>
    {{# }); }}
</script>

<script th:inline="none">
    let current_row_data;
    let selected_tree_node;
    let table;
    let tree;
    let reloading = false;
    let form;
    let dataList;
    let laytpl;

    layui.use(function () {
        table = layui.table;
        tree = layui.tree;
        form = layui.form;
        laytpl = layui.laytpl;

        const fullscreen = new FullScreen();

        get(router.equip_type, null, function (result) {
            $.each(result, function (index, item) {
                $('#type').append(new Option(item, index));
            })
            form.render();
        })

        get(router.workshop_tree, null, function (result) {
                const sceneTree = new TreeSelect({
                    data: result,
                    needVirtualRoot: true,
                    virtualRootName: i18np.prop('common.all'),
                    customName: {
                        title: 'name',
                        field: 'selfCode'
                    },
                    onSelect: function (obj) {
                        //获取当前点击的节点数据
                        selected_tree_node = obj;
                        reloadData();
                    }
                })
            }
        )

        reloadData();


        form.on('submit(tb-common-search)', function (data) {
            reloadData(true, data.field);
            return false; // 阻止默认 form 跳转
        });
    });

    function openEdit(id) {
        openWindow('common.edit', '/view/equip_form_edit?id=' + id, ['90%', '90%']);
    }

    function openAttrHistory(sn) {
        openWindow('data.collect', '/view/equip_collect_tables?sn=' + sn, ['90%', '90%']);
    }

    function openCollectEcharts(sn) {
        openWindow('data.echart', '/view/equip_collect_echarts?sn=' + sn, ['40%', '90%']);
    }

    function openRunEcharts(sn) {
        openWindow('data.echart', '/view/equip_run_echarts?sn=' + sn, ['40%', '70%']);
    }

    function reloadData() {
        if (reloading) return;
        reloading = true;

        try {
            let params = {
                workshopCode: selected_tree_node == null ? null : selected_tree_node.selfCode,
                name: $('#name').val(),
                selfCode: $('#selfCode').val(),
                type: $('#type').val(),
                needRealtime: true,
                requirePage: false,
                needWorkshopCascade: true,
                queryWorkshop: true,
                queryAttrs: true,
            };
            post(router.equip_page, params, function (e) {
                if (e == null) {
                    return;
                }
                dataList = e;
                const tpl = document.getElementById('deviceCardTpl').innerHTML;
                const container = document.getElementById('cardContainer');

                laytpl(tpl).render(dataList, function (html) {
                    container.innerHTML = html;
                });
            })
        } finally {
            reloading = false;
        }
    }

    setInterval(async () => {
        reloadData();
    }, 5000);
</script>
</body>

<style>
    .status-dot {
        margin: 2px;
    }

    .device-card {
        margin: 5px;
        padding: 10px;
        border: 1px solid #eceaea; /* 主边框颜色，可自定义 */
        border-radius: 10px; /* 圆角 */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* 浅阴影增加浮雕感 */
        transition: all 0.2s ease; /* hover 平滑过渡 */
        background-color: #fff; /* 防止透明影响阴影 */
        overflow: hidden; /* 防止子元素溢出 */
    }

    .device-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
    }

    .device-card .layui-card-header {
        display: flex;
        align-items: center;
        flex-direction: column;
    }

    .card-header-1 {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        flex-direction: row;
    }

    .card-header-2 {
        display: flex;
        justify-content: space-between;
        flex-direction: column;
        font-size: 12px;
        padding-top: 5px;
    }

    .device-card .layui-card-body {
        font-size: 13px;
        height: 30px;
        overflow-y: auto;
    }

    .layui-card-footer {
        text-align: right;
    }
</style>
</html>