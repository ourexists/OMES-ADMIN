<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <script src="../static/js/echarts.min.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <form class="layui-form layui-row layui-col-space16">
        <div class="layui-form-item">
            <div class="layui-inline" id="timeduration">
                <div class="layui-input-inline">
                    <input type="text" autocomplete="off" id="startDate" name="startDate"
                           class="layui-input"
                           placeholder="startTime" lang-i18n="common.starttime">
                </div>
                <div class="layui-form-mid">-</div>
                <div class="layui-input-inline">
                    <input type="text" autocomplete="off" id="endDate" name="endDate" class="layui-input"
                           placeholder="endTime" lang-i18n="common.endtime">
                </div>
            </div>
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="tb-common-search"
                    lang-i18n="common.search">
                Search
            </button>
        </div>
    </form>
    <div id="chart-container"></div>
</div>

<script th:inline="none">
    let datalist = [];
    let config_data = [];
    let sn;
    let chart;

    layui.use(function () {
        let form = layui.form;
        let laydate = layui.laydate;

        sn = layui.url().search.sn;

        laydate.render({
            elem: '#timeduration',
            range: ['#startDate', '#endDate'],
            rangeLinked: true,
            type: 'datetime',
            lang: localStorage.getItem(store.language)
        });

        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        $('#startDate').val(formatDate(startOfDay));
        $('#endDate').val(formatDate(endOfDay));

        // 搜索提交
        form.on('submit(tb-common-search)', function (data) {
            let field = data.field;
            if (field.startDate !== null && field.endDate !== null
                && field.startDate !== '' && field.endDate !== '') {
                reloadTb();
            }
            return false; // 阻止默认 form 跳转
        });

        setTimeout(() => {
            reloadAll();
        }, 100)
    });

    function reloadTb() {
        post(router.equip_collect_page, {
            sn,
            startDate: $('#startDate').val(),
            endDate: $('#endDate').val(),
            requirePage: false
        }, function (res) {
            if (res === null) {
                return;
            }
            datalist = res;
            let option = generateOption(config_data);
            chart.setOption(option);
        })
    }

    function reloadAll() {
        get(router.equip_config_sn, {"equipSn": sn}, function (d) {
            if (d == null) {
                return
            }
            if (d.config == null) {
                return;
            }
            let r = d.config.attrs;
            if (r.length > 0) {
                r.forEach(e => {
                    if (e.needCollect) {
                        config_data.push(e);
                    }
                });
            }
            if (config_data.length > 0) {
                let baseSize = 200;
                let size = config_data.length * baseSize;

                $("#chart-container").css({
                    width: '100%',
                    height: size + 'px'
                });
                const dom = $('#chart-container')[0];
                chart = echarts.init(dom);
                reloadTb()
            }
        })
    }

    function generateOption() {
        let visualMap = [];
        let xAxis = [];
        let yAxis = [];
        let grid = [];
        let series = [];
        let title = [];
        let single = 100 / config_data.length;

        config_data.forEach((item, index) => {
            visualMap.push(
                {
                    show: false,
                    type: 'continuous',
                    seriesIndex: index,
                }
            );
            title.push({
                top: (single / 15 + single * index) + '%',
                left: 'center',
                text: item.name
            });
            xAxis.push({
                gridIndex: index,
                type: 'time',
                splitLine: {
                    show: false
                },
                axisLabel: {
                    rotate: 45,  // 旋转标签，避免重叠
                    interval: "auto"  // 自动调整显示间隔
                }
            })
            yAxis.push({
                type: 'value',
                gridIndex: index,
                splitLine: {
                    show: false
                },
            })
            grid.push({
                top: (single / 5 + single * index) + '%',
                height: (single * 3 / 5) + '%'
            },)
            let vList = []
            datalist.forEach(item2 => {
                let d = item2.data[item.name];
                if (d != null) {
                    vList.push([item2.time, d])
                } else {
                    vList.push([item2.time, ""])
                }
            })
            series.push({
                type: 'line',
                areaStyle: {},
                smooth: true,
                showSymbol: false,
                data: vList,
                xAxisIndex: index,
                yAxisIndex: index
            })
        })
        return {
            visualMap,
            title,
            tooltip: {
                trigger: 'axis'
            },
            xAxis,
            yAxis,
            grid,
            series
        };
    }
</script>
</body>
</html>