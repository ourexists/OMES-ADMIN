<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <table class="layui-hide" id="tb-common"></table>
</div>

<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="addNode">
            <i class="layui-icon layui-icon-addition"></i>
        </a>
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="edit">
            <i class="layui-icon layui-icon-edit"></i>
        </a>
        {{# if (d.status===1) { }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="start">
            <i class="layui-icon layui-icon-play"></i>
        </a>
        {{# } else { }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="stop">
            <i class="layui-icon layui-icon-pause"></i>
        </a>
        {{# } }}
        <a class="layui-btn layui-btn-xs  layui-btn-primary layui-bg-red" lay-event="del">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="refresh">
            <i class="layui-icon layui-icon-refresh"></i>
        </a>
        <a class="layui-btn layui-btn-sm layui-btn-primary" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
        </a>
        <a class="layui-btn layui-btn-sm layui-bg-red" lay-event="deleteBatch">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
    </div>

</script>

<script th:inline="javascript">
    var table;
    var data = [];
    let dgId;
    layui.use(['form', 'treeTable', 'dropdown', 'layer', 'util'], function () {
        table = layui.treeTable;
        var layer = layui.layer;

        dgId = layui.url().search.id;

        reloadTb();
        // 创建表格实例
        table.render({
            elem: '#tb-common',
            headers: getCommonHeader(),
            contentType: 'application/json',
            loading: false,
            toolbar: '#tb-toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
            tree: {
                customName: {
                    id: 'code',
                    pid: 'pcode'
                },
                view: {
                    expandAllDefault: true
                }
            },
            cols: [[
                {type: 'checkbox', title: '', fixed: true}, // 单选框
                {field: 'selfCode', title: i18np.prop('dev.code')},
                {field: 'name', title: i18np.prop('dev.name')},
                {field: 'typeDesc', title: i18np.prop("dev.type")},
                {field: 'localizationDesc', title: i18np.prop("dev.localization")},
                {field: 'maxCapacity', title: i18np.prop("dev.maxCapacity")},
                {field: 'availableCapacity', title: i18np.prop("dev.availableCapacity")},
                {field: 'statusDesc', title: i18np.prop("dev.status")},
                {field: 'matCode', title: i18np.prop('material.code')},
                {
                    field: 'matName', title: i18np.prop('material.name'), templet: function (r) {
                        return r.materialDto == null ? '' : r.materialDto.name
                    }
                },
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#tb-tool'
                }
            ]],
            page: false,
            height: 'full'
        });
        // 工具栏事件
        table.on('toolbar(tb-common)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'getCheckData':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    var getData = table.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
                case 'add':
                    openWindow("common.add", '/view/dev_form_edit?dgId=' + dgId);
                    break;
                case 'deleteBatch':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    var ids = [];
                    $.each(data, function (i, n) {
                        ids.push(n.id);
                    });
                    delWindow(router.dev_del, ids, reloadTb);
                    break;
                case 'refresh':
                    reloadTb();
                    break
            }
        });

        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'del') {
                delWindow(router.dev_del, [data.id], reloadTb);
            } else if (obj.event === 'edit') {
                openWindow("common.edit", '/view/dev_form_edit?id=' + data.id);
            } else if (obj.event === 'addNode') {
                openWindow("common.add.node", '/view/dev_form_edit?dgId=' + dgId + '&pcode=' + data.code);
            } else if (obj.event === 'start') {
                get(router.dev_enable, {'id': data.id}, function (re) {
                    reloadTb();
                })
            } else if (obj.event === 'stop') {
                get(router.dev_disable, {'id': data.id}, function (re) {
                    reloadTb();
                })
            }
        });
    })

    function reloadTb() {
        if (dgId !== null) {
            var param = {
                "dgId": dgId
            }
            get(router.dev_page, param, function (result) {
                data = result;
                table.reloadData('tb-common', {
                    data: data
                });
            })
        }
    }
</script>
</body>
</html>