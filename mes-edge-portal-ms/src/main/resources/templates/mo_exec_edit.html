<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <link href="../static/step-lay/step.css" rel="stylesheet">
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <style>
        table {
            table-layout: fixed;
            word-break: break-all;
        }

        td {
            overflow: auto;
        }
    </style>
</head>
<body type="text/html" id="bom-toolbar">
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 16px;">
            <div class="layui-carousel" id="stepForm" lay-filter="stepForm">
                <div carousel-item>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="common-edit-form"
                              lay-filter="common-edit-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="common.order.code"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="selfCode" autocomplete="off"
                                               class="layui-input era-unable-edit era-detail-disabled"
                                               disabled>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mo.num"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="num" id="num" autocomplete="off"
                                               class="layui-input era-detail-disabled"
                                               disabled>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mo.surplus"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="surplus" id="surplus" autocomplete="off"
                                               class="layui-input era-detail-disabled" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="bom.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="productName" autocomplete="off" lay-verify="required"
                                               class="layui-input" disabled>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="bom.code"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="productCode" autocomplete="off" lay-verify="required"
                                               class="layui-input" disabled>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mo.weight"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="weight" autocomplete="off" lay-verify="required"
                                               class="layui-input era-detail-disabled" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mps.sequence"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="sequence" autocomplete="off" placeholder=""
                                               lay-verify="required"
                                               class="layui-input"
                                               onKeyUp="this.value = input_limit_int(this.value)">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mps.execTime"></label>
                                    <div class="layui-input-inline layui-input-wrap">
                                        <div class="layui-input-prefix">
                                            <i class="layui-icon layui-icon-date"></i>
                                        </div>
                                        <input type="text" class="layui-input" id="execTime" name="execTime"
                                               lay-verify="required">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <input type="radio" name="execType" lay-filter="execType"
                                           lang-i18n="mps.execType.average"
                                           value="0" checked>
                                    <input type="radio" name="execType" lay-filter="execType"
                                           lang-i18n="mps.execType.part"
                                           value="1">
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" id="execNumDesc" lang-i18n="mps.exec.num"></label>
                                    <div class="layui-input-inline layui-input-wrap">
                                        <input type="text" name="execNum" id="execNum" autocomplete="off"
                                               lay-verify="required"
                                               class="layui-input" onKeyUp="this.value = input_limit_int(this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button class="layui-btn" id="formStep" lay-submit lay-filter="formStep"
                                            lang-i18n="common.step.next">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="devg-form"
                              lay-filter="devg-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="devg.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="devgName" autocomplete="off" placeholder=""
                                               disabled class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline" style="display:none">
                                    <div class="layui-input-block">
                                        <input type="text" name="devgId" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline era-detail-hidden">
                                    <button type="button" id="form-select-devg-btn"
                                            class="layui-btn layui-btn-primary layui-border-blue "
                                            lang-i18n="select.devg"></button>
                                </div>
                            </div>
                            <table class="layui-hide" id="tb-line-detail"></table>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn pre"
                                            lang-i18n="common.step.last"></button>
                                    <button class="layui-btn" id="formStep2" lay-submit lay-filter="formStep2"
                                            lang-i18n="common.step.next">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="tf-form"
                              lay-filter="tf-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="line.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="line" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline" style="display:none">
                                    <div class="layui-input-block">
                                        <input type="text" name="lineCode" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline era-detail-hidden">
                                    <button type="button" id="form-select-line-btn"
                                            class="layui-btn layui-btn-primary layui-border-blue "
                                            lang-i18n="select.line"></button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <table class="layui-hide" id="tb-tf-detail"></table>
                            </div>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn pre"
                                            lang-i18n="common.step.last"></button>
                                    <button class="layui-btn" id="formStep3" lay-submit lay-filter="formStep3"
                                            lang-i18n="common.step.next">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <table class="layui-hide" id="tb-flow-mps"></table>
                        <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                            <div class="layui-input-block">
                                <button type="button" class="layui-btn pre"
                                        lang-i18n="common.step.last"></button>
                                <button class="layui-btn" lay-submit lay-filter="formStep4"
                                        lang-i18n="common.complete">
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="text-align: center;margin-top: 90px;">
                            <i class="layui-icon layui-circle"
                               style="color: white;font-size:30px;font-weight:bold;background: #52C41A;padding: 20px;line-height: 80px;">&#xe605;</i>
                            <div style="font-size: 24px;color: #333;font-weight: 500;margin-top: 30px;"
                                 lang-i18n="mps.create.success">
                            </div>
                        </div>
                        <div style="text-align: center;margin-top: 50px;">
                            <button class="layui-btn layui-btn-primary" lang-i18n="common.query" lay-submit
                                    lay-filter="queryMps"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script th:inline="none">
    var current_row_data = {};
    var details;
    var tfDatas;
    var table;
    var form;
    var parmas;
    layui.use(["form", "table", 'step', 'laydate'], function () {
        form = layui.form;
        table = layui.table;
        var step = layui.step,
            laydate = layui.laydate;

        let id = layui.url().search.id;

        $(".era-unable-edit").attr("disabled", "block");
        var param = {
            "id": id
        }
        get(router.mo_id, param, function (result) {
            current_row_data = result;
            details = result.detailDtoList;
            form.val("common-edit-form", {
                "productName": current_row_data.productName,
                "selfCode": current_row_data.selfCode,
                "productCode": current_row_data.productCode,
                "num": current_row_data.num,
                "tenantId": current_row_data.tenantId,
                "execNum": current_row_data.surplus,
                "weight": current_row_data.weight,
                "surplus": current_row_data.surplus,
                "execTime": current_row_data.execTime,
                "sequence": 0,
            });
            if (current_row_data.lineCode != null) {
                selectLine({"selfCode": current_row_data.lineCode})
            }
            reloadTb();
        })

        laydate.render({
            elem: '#execTime',
            type: 'datetime',
            fullPanel: true,
            lang: localStorage.getItem("language")
        });

        step.render({
            elem: '#stepForm',
            filter: 'stepForm',
            width: '100%', //设置容器宽度
            stepWidth: '750px',
            height: '500px',
            stepItems: [{
                title: i18np.prop('mps.design')
            }, {
                title: i18np.prop('devg.name')
            }, {
                title: i18np.prop('line.name')
            }, {
                title: i18np.prop('mps.sure')
            }, {
                title: i18np.prop('common.complete')
            }]
        });


        table.render({
            elem: '#tb-line-detail',
            defaultToolbar: '',
            data: details,
            cols: [[
                {field: 'matName', title: i18np.prop("material.name")},
                {field: 'matCode', title: i18np.prop("material.code")},
                {field: 'matNum', title: i18np.prop("material.num")},
                {field: 'devNo', title: i18np.prop("dev.code")},
                {field: 'devName', title: i18np.prop("dev.name")},
                {field: 'dgCode', title: i18np.prop("devg.code")},
                {field: 'dgName', title: i18np.prop("devg.name")},
                {
                    field: 'priority',
                    title: i18np.prop("common.priority"),
                    edit: 'text',
                    style: 'color: red;'
                }
            ]],
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
            done: function () {
                layui.$(document).on('focus', 'td[data-field$="priority"] .layui-table-edit', function () {
                    layui.$(this).attr("onKeyUp", "this.value=input_limit_int(this.value)")
                });
            }
        });


        table.render({
            elem: '#tb-tf-detail',
            defaultToolbar: '',
            cols: [[
                {type: 'checkbox', title: '', fixed: true}, // 单选框
                {field: 'LAY_INDEX', title: 'NO'},
                {field: 'selfCode', title: i18np.prop('mps.tf.code')},
                {field: 'name', title: i18np.prop('mps.tf.name')},
                {field: 'property', title: i18np.prop("mps.tf.property"), style: 'color: red;', edit: 'text',},
                {field: 'duration', title: i18np.prop("mps.tf.duration"), style: 'color: red;', edit: 'text',},
                {field: 'temperature', title: i18np.prop("mps.tf.temperature"), style: 'color: red;', edit: 'text',},
                {field: 'mapDb', title: i18np.prop("mps.tf.mapDb")},
                {field: 'mapOffset', title: i18np.prop("mps.tf.offset")},
                // {field: 'pre', title: i18np.prop('mps.tf.pre')},
                // {field: 'nex', title: i18np.prop('mps.tf.next')},
            ]],
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
            done: function () {
                layui.$(document).on('focus', 'td[data-field$="duration"] .layui-table-edit', function () {
                    layui.$(this).attr("onKeyUp", "this.value=input_limit_int(this.value)")
                });
            }
        });

        table.render({
            elem: '#tb-flow-mps',
            defaultToolbar: '',
            cols: [[
                {field: 'moCode', title: i18np.prop("mo.code")},
                {
                    field: 'productCode', title: i18np.prop("bom.code"),
                    templet: function (d) {
                        return d.moDto == null ? '' : d.moDto.productCode
                    }
                },
                {
                    field: 'productName', title: i18np.prop("bom.name"),
                    templet: function (d) {
                        return d.moDto == null ? '' : d.moDto.productName
                    }
                },
                {field: 'num', title: i18np.prop("mo.num")},
                {field: 'weight', title: i18np.prop("mps.weight")},
                {field: 'execTime', title: i18np.prop("mps.execTime")},
                {
                    field: 'line',
                    title: i18np.prop("line.name"),
                    templet: function (d) {
                        return d.lineVo == null ? '' : d.lineVo.name
                    }
                },
                {field: 'batch', title: i18np.prop("mps.batch")},
            ]],
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
        });

        $('#form-select-line-btn').click(function () {
            openWindow("select.line", "/view/line_tables?page_type=2", ['95%', '80%']);
        })

        $('#form-select-devg-btn').click(function () {
            openWindow("select.devg", "/view/devg_tables?page_type=2", ['95%', '80%']);
        })

        form.on('submit(formStep)', function (data) {
            if (data.field.execNum > current_row_data.surplus) {
                layer.msg(i18np.prop('mps.msg.over'));
                return false;
            }
            if (data.field.execNum < 1) {
                layer.msg(i18np.prop('mps.msg.zero'));
                return false;
            }
            parmas = {
                'moCode': current_row_data.selfCode,
                'sequence': data.field.sequence,
                'execTime': data.field.execTime,
                'execType': data.field.execType,
                'execNum': data.field.execNum,
            }
            step.next('#stepForm');
            return false;
        });

        form.on('submit(formStep2)', function (data) {
            parmas.details = details;
            step.next('#stepForm');
            return false;
        });

        form.on('submit(formStep3)', function (data) {
            if (data.field.lineCode === null) {
                step.next('#stepForm');
                return false;
            }
            parmas.line = data.field.lineCode;
            parmas.tfs = tfDatas;
            post(router.mps_flow, parmas, function (result) {
                table.reload('tb-flow-mps', {
                    data: result
                })
                step.next('#stepForm');
            })
            return false;
        });

        form.on('submit(formStep4)', function (data) {
            var param = table.getData('tb-flow-mps');
            post(router.flow_mps_complete, param, function (result) {
                parent.reloadTb();
                step.next('#stepForm');
            })
            return false;
        });

        form.on('submit(queryMps)', function (data) {
            parent.parent.openIndexTab('/view/mps_tables?moCode=' + current_row_data.selfCode, 'queryMPS_' + current_row_data.selfCode, i18np.prop('menu.mps'))
            closeWindow();
            return false;
        });

        $('.pre').click(function () {
            step.pre('#stepForm');
        });

        $('.next').click(function () {
            step.next('#stepForm');
        });
    });

    function reloadTb() {
        table.reload('tb-line-detail', {
            data: details
        })
    }

    function selectLine(data) {
        var param = {
            "code": data.selfCode
        }
        get(router.line_code, param, function (result) {
            form.val("tf-form", {
                "line": result.name,
                "lineCode": result.selfCode
            });
            tfDatas = result.tfs;
            table.reload('tb-tf-detail', {
                data: tfDatas
            })
        })
    }

    function selectDevg(data) {
        form.val("devg-form", {
            "devgName": data.name,
            "devgId": data.id
        });
        var param = {
            "dgId": data.id
        }
        get(router.dev_dgId, param, function (result) {
            console.info(result)
            console.info(details)
            $.each(details, function (index, value) {
                value.devNo = null;
                value.devName = null;
                value.dgCode = null;
                value.dgName = null;
                $.each(result, function (i, d) {
                    if (value.matCode === d.matCode) {
                        value.devNo = d.selfCode;
                        value.devName = d.name;
                        value.dgCode = data.selfCode;
                        value.dgName = data.name;
                    }
                })
            });
            reloadTb();
        })
    }
</script>
</body>
</html>