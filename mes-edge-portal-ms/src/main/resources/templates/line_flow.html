<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <table class="layui-hide" id="tb-common"></table>
</div>

<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="edit">
            <i class="layui-icon layui-icon-edit"></i>
        </a>
        <a class="layui-btn layui-btn-xs  layui-btn-primary layui-bg-red" lay-event="del">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="refresh">
            <i class="layui-icon layui-icon-refresh"></i>
        </a>
        <a class="layui-btn layui-btn-sm layui-btn-primary" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
        </a>
        <a class="layui-btn layui-btn-sm layui-bg-red" lay-event="deleteBatch">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
        <span style="color:red;font-style: italic">{{ i18np.prop('common.msg.sort') }}</span>
    </div>

</script>

<script th:inline="javascript">
    var table;
    var data = [];
    let line_id;
    layui.use(['form', 'table', 'dropdown', 'layer', 'util', 'soulTable'], function () {
        table = layui.table;
        var layer = layui.layer,
            soulTable = layui.soulTable;

        line_id = layui.url().search.line_id;

        reloadTb();

        // 创建表格实例
        table.render({
            elem: '#tb-common',
            headers: getCommonHeader(),
            contentType: 'application/json',
            loading: false,
            toolbar: '#tb-toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {type: 'checkbox', title: '', fixed: true}, // 单选框
                {field: 'LAY_INDEX', title: 'NO'},
                {field: 'selfCode', title: i18np.prop('mps.tf.code')},
                {field: 'name', title: i18np.prop('mps.tf.name')},
                {field: 'property', title: i18np.prop("mps.tf.property")},
                {field: 'typeDesc', title: i18np.prop("mps.tf.type")},
                {field: 'mapDb', title: i18np.prop("mps.tf.mapDb")},
                {field: 'mapOffset', title: i18np.prop("mps.tf.offset")},
                {field: 'duration', title: i18np.prop("mps.tf.duration")},
                {field: 'temperature', title: i18np.prop("mps.tf.temperature")},
                // {field: 'pre', title: i18np.prop('mps.tf.pre')},
                // {field: 'nex', title: i18np.prop('mps.tf.next')},
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#tb-tool'
                }
            ]],
            rowDrag: {
                done: function (obj) {
                    var pre = obj.cache[obj.newIndex - 1];
                    var post = obj.cache[obj.newIndex + 1];
                    var param = {
                        'pre': pre == null ? null : pre.id,
                        'post': post == null ? null : post.id,
                        'current': obj.row.id
                    }
                    window.post(router.tf_changePriority, param, function (result) {
                        reloadTb();
                    })
                }
            },
            done: function () {
                soulTable.render(this);
            },
            page: false,
            height: 'full'
        });
        // 工具栏事件
        table.on('toolbar(tb-common)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'getCheckData':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    var getData = table.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
                case 'add':
                    openWindow("common.add", '/view/line_flow_edit?line_id=' + line_id);
                    break;
                case 'deleteBatch':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    var ids = [];
                    $.each(data, function (i, n) {
                        ids.push(n.id);
                    });
                    delWindow(router.tf_del, ids, reloadTb);
                    break;
                case 'refresh':
                    reloadTb();
                    break
            }
        });

        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'del') {
                delWindow(router.tf_del, [data.id], reloadTb);
            } else if (obj.event === 'edit') {
                openWindow("common.edit", '/view/line_flow_edit?id=' + data.id);
            }
        });
    })

    function reloadTb() {
        if (line_id !== null) {
            var param = {
                "lineId": line_id
            }
            get(router.tf_lineId, param, function (result) {
                data = result;
                table.reloadData('tb-common', {
                    data: data
                });
            })
        }
    }
</script>
</body>
</html>