<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <div class="layui-col-sm12 layui-col-md4 layui-col-lg3">
        <div class="layui-card">
            <div class="layui-card-body mini-bar" id="ltTree">
                <div class="layui-inline">
                    <input type="text" id="tree_name" class="layui-input" autocomplete="off"/>
                </div>
                <a class="layui-btn layui-btn-sm layui-btn-primary" id="tree_query">
                    <i class="layui-icon layui-icon-search"></i>
                </a>
                <a class="layui-btn layui-btn-sm layui-btn-primary" lay-on="reload">
                    <i class="layui-icon layui-icon-refresh"></i>
                </a>
                <div id="left-tree"></div>
            </div>
        </div>
    </div>
    <div class="layui-col-sm12 layui-col-md9 layui-col-lg9" style="padding: 15px;">
        <form class="layui-form layui-row layui-col-space16">
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <div class="layui-inline" id="timeduration">
                        <div class="layui-input-inline">
                            <input type="text" autocomplete="off" id="startDate" name="startDate"
                                   class="layui-input"
                                   placeholder="startTime" lang-i18n="common.starttime">
                        </div>
                        <div class="layui-form-mid">-</div>
                        <div class="layui-input-inline">
                            <input type="text" autocomplete="off" id="endDate" name="endDate" class="layui-input"
                                   placeholder="endTime" lang-i18n="common.endtime">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-btn-container layui-col-xs12">
                <button class="layui-btn" lay-submit lay-filter="tb-common-search" lang-i18n="common.search">
                    Search
                </button>
                <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.clear">Clear</button>
            </div>
        </form>
        <table class="layui-hide" id="tb-common"></table>
    </div>
</div>

<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-primary" id="rowMode">
            <span>{{= d.lineStyle ? i18np.prop('common.mode.multi') : i18np.prop('common.mode.single') }}</span>
            <i class="layui-icon layui-icon-down layui-font-12"></i>
        </button>
    </div>
</script>

<script th:inline="none">
    var current_row_data;
    var selected_tree_node;
    var table;
    var tree;
    var attrIds = [];

    layui.use(function () {
        table = layui.table;
        tree = layui.tree;
        var form = layui.form;
        var dropdown = layui.dropdown;
        var layer = layui.layer;
        var util = layui.util;
        var laydate = layui.laydate;

        laydate.render({
            elem: '#timeduration',
            range: ['#startDate', '#endDate'],
            rangeLinked: true,
            type: 'datetime',
            lang: localStorage.getItem(store.language)
        });

        get(router.workshop_tree, null, function (result) {
            tree.render({
                elem: '#left-tree',
                data: result,
                onlyIconControl: true,  // 是否仅允许节点左侧图标控制展开收缩
                id: 'left-tree',
                edit: [],
                extEdit: true,
                customName: { // 自定义 data 字段名 --- 2.8.14+
                    title: 'name',
                    field: 'code'
                },
                click: function (obj) {
                    $(".layui-tree-set").removeClass('layui-tree-set-active');
                    obj.elem.addClass('layui-tree-set-active');
                    //获取当前点击的节点数据
                    selected_tree_node = obj.data;
                    reloadAll();
                }
            });
        }, function (code, msg) {
            alert("请重试");
        })

        // 创建表格实例
        table.render({
            elem: '#tb-common',
            method: 'POST',
            headers: getCommonHeader(),
            contentType: 'application/json',
            loading: false,
            toolbar: '#tb-toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
            totalRow: true,
            cols: [[]],
            text: {
                none: i18np.prop('common.msg.selecttime')
            },

            done: function () {
                // 行模式
                dropdown.render({
                    elem: '#rowMode',
                    data: [{
                        id: 'default-row',
                        title: i18np.prop('common.mode.single')
                    }, {
                        id: 'multi-row',
                        title: i18np.prop('common.mode.multi')
                    }],
                    // 菜单被点击的事件
                    click: function (obj) {
                        switch (obj.id) {
                            case 'default-row':
                                table.reload('tb-common', {
                                    lineStyle: null
                                });
                                break;
                            case 'multi-row':
                                table.reload('tb-common', {
                                    lineStyle: 'height: 95px;'
                                });
                                break;
                        }
                    }
                });
            },
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "data": res.data.data,
                    "totalRow": res.data.calc
                };
            },
            page: false,
            height: 'full'
        });
        // 工具栏事件
        table.on('toolbar(tb-common)', function (obj) {
            if (selected_tree_node == null) {
                layer.msg(i18np.prop("bomc.msg.select"));
                return;
            }
            let id = obj.config.id;
            let checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'getCheckData':
                    let data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    let getData = table.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
            }
        });

        // table 滚动时移除内部弹出的元素
        let tableInst = table.getOptions('tb-common');
        tableInst.elem.next().find('.layui-table-main').on('scroll', function () {
            dropdown.close('dropdown-table-tool');
        });

        // 搜索提交
        form.on('submit(tb-common-search)', function (data) {
            let field = data.field;
            if (selected_tree_node !== null && field.startDate !== null && field.endDate !== null
                && field.startDate !== '' && field.endDate !== '') {
                reloadTb();
            }
            return false; // 阻止默认 form 跳转
        });

        $('#tree_query').click(function () {
            var name = $("#tree_name").val(); //搜索值
            var elem = $("#left-tree").find('.layui-tree-txt').css('color', ''); //搜索文本与设置默认颜色
            if (!name) {
                return; //无搜索值返回
            }
            elem.filter(':contains(' + name + ')').css('color', '#FFB800'); //搜索文本并设置标志颜色
            elem.parents('.layui-tree-pack').prev().find('.layui-tree-iconClick').click(); //展开选项
        });

        util.event('lay-on', {
            reload: function () {
                reloadTree();
            }
        });
    });

    function reloadTb() {
        let title = i18np.prop('workshop.name') + ":" + selected_tree_node.name + "<br>"
            + i18np.prop('workshop.name') + ":" + $('#startDate').val() + " ~ " + $('#endDate').val();
        table.reload('tb-common', {
            url: initRequestUrl(router.ecrecord_page),
            customTitleRow: title,
            where: {
                attrIds: attrIds,
                startTime: $('#startDate').val(),
                endTime: $('#endDate').val(),
            },
        });
    }

    function reloadAll() {
        post(router.ecattr_page, {"workshopId": selected_tree_node.id, requirePage: false}, function (r) {
            let tbCols = []
            let col = [];
            if (r.length > 0) {
                col.push({
                    field: 'time',
                    title: i18np.prop("common.time"),
                    fixed: 'left',
                    totalRow: i18np.prop("ec.calc")
                })
                r.forEach(e => {
                    let k = {field: e.id, title: e.name, totalRow: true}
                    attrIds.push(e.id);
                    col.push(k);
                });
            }
            tbCols.push(col)
            if ($('#startDate').val() == null || $('#startDate').val() == ''
                || $('#endDate').val() == null || $('#endDate').val() == '') {
                table.reload('tb-common', {
                    cols: tbCols,
                })
            } else {
                let title = i18np.prop('workshop.name') + ":" + selected_tree_node.name + "\r"
                    + i18np.prop('workshop.name') + ":" + $('#startDate').val() + "-" + $('#endDate').val();
                table.reload('tb-common', {
                    cols: tbCols,
                    customTitleRow: title,
                    url: initRequestUrl(router.ecrecord_page),
                    where: {
                        attrIds: attrIds,
                        startTime: $('#startDate').val(),
                        endTime: $('#endDate').val(),
                    },
                })
            }
        })
    }

    function reloadTree() {
        get(router.platform_all, null, function (result) {
            tree.reload("left-tree", {data: result});
        })
    }
</script>
</body>
</html>