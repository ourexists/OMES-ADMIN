<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/leaflet/leaflet.css"/>
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <script src="../static/leaflet/leaflet.js"></script>
</head>
<style>
    #map {
        width: 100%;
        height: 600px;
        margin-top: 10px;
    }
</style>
<body>
<div style="padding: 16px;">
    <form class="layui-form layui-form-pane" action="" id="common-edit-form" lay-filter="common-edit-form">
        <div class="layui-form-item">

            <label class="layui-form-label" lang-i18n="equip.name" style="font-weight: bold "></label>
            <div class="layui-input-block">
                <input type="text" name="name" autocomplete="off" lay-verify="required"
                       class="layui-input" lang-i18n="common.placeholder">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" lang-i18n="equip.code" style="font-weight: bold "></label>
            <div class="layui-input-block">
                <input type="text" name="selfCode" autocomplete="off" lay-verify="required"
                       class="layui-input lay-unable-edit" lang-i18n="common.placeholder">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" lang-i18n="equip.type" style="font-weight: bold "></label>
            <div class="layui-input-block">
                <select name="type" id="type">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label" lang-i18n="equip.runMap"></label>
                <div class="layui-input-block">
                    <input type="text" name="runMap" autocomplete="off" lay-verify="phone"
                           class="layui-input" lang-i18n="common.placeholder">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" lang-i18n="equip.alarmMap"></label>
                <div class="layui-input-block">
                    <input type="text" name="alarmMap" autocomplete="off" lay-verify="email"
                           class="layui-input" lang-i18n="common.placeholder">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">经度</label>
            <div class="layui-input-inline">
                <input type="text" name="lng" disabled class="layui-input">
            </div>

            <label class="layui-form-label" style="">纬度</label>
            <div class="layui-input-inline">
                <input type="text" name="lat" disabled class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="">地址</label>
            <div class="layui-input-block">
                <input type="text" name="address" disabled class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">地址定位</label>
            <div class="layui-input-inline">
                <input type="text" id="searchText" placeholder="输入地址 / 地点名称"
                       class="layui-input">
            </div>
            <button type="button" class="layui-btn layui-btn-primary" id="btnSearch">搜索
            </button>
        </div>
        <div class="layui-form-item">
            <div id="map"></div>
        </div>
        <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 5%; z-index: 999">
            <button class="layui-btn" lay-submit lay-filter="common-edit-button" lang-i18n="common.msg.confirm">确认
            </button>
            <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.msg.reset">重置</button>
        </div>
    </form>
</div>
<script>
    var current_row_data = parent.current_row_data;
    var selected_tree_node = parent.selected_tree_node;
    layui.use(function () {
        let form = layui.form,
            layer = layui.layer;

        get(router.equip_type, null, function (result) {
            $.each(result, function (index, item) {
                $('#type').append(new Option(item.name, item.id));
            })
            form.render();
        })

        let ln = [32.060255, 118.796877]
        if (current_row_data != null) {
            form.val("common-edit-form", Object.assign({}, current_row_data));
            if (current_row_data.selfCode !== "") {
                $(".lay-unable-edit").attr("disabled", "block");
            }
            if (current_row_data.lat != null && current_row_data.lng != null) {
                ln = [current_row_data.lat, current_row_data.lng];
            }
        } else {
            form.val("common-edit-form", {});
            current_row_data = {}
        }
        let map = L.map('map').setView(ln, 6);
        let marker;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        if (current_row_data != null && current_row_data.lat != null && current_row_data.lng != null) {
            setPoint(current_row_data.lat, current_row_data.lng);
        }

        // 提交事件
        form.on('submit(common-edit-button)', function (data) {
            var field = data.field; // 获取表单字段值
            for (let key in field) {
                current_row_data[key] = field[key];
            }
            if (selected_tree_node != null) {
                current_row_data.workshopCode = selected_tree_node.selfCode;
            }
            post(router.equip_edit, current_row_data, function () {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                parent.reloadTb();
            }, function (code, msg) {
                layer.alert(msg, {
                    title: 'error'
                });
            })
            return false;
        });

        // ===== 搜索按钮 =====
        $('#btnSearch').click(function () {
            var keyword = $('#searchText').val();
            if (!keyword) {
                layer.msg('请输入搜索内容');
                return;
            }
            searchLocation(keyword);
        });

        // ===== 搜索函数 =====
        function searchLocation(keyword) {
            fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}`
            )
                .then(res => res.json())
                .then(list => {
                    if (!list || list.length === 0) {
                        layer.msg('未找到位置');
                        return;
                    }
                    var p = list[0];
                    setPoint(p.lat, p.lon);
                    form.val('common-edit-form', {
                        address: p.display_name
                    });
                });
        }

        function setPoint(lat, lng) {
            lat = Number(lat).toFixed(6);
            lng = Number(lng).toFixed(6);
            map.setView([lat, lng], 15);

            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([lat, lng]).addTo(map);

            form.val('common-edit-form', {
                lat: lat,
                lng: lng,
            });
        }

        function reverseAddress(lat, lng) {
            fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
            )
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.display_name) {
                        return;
                    }
                    // display_name 就是完整可读地址
                    form.val('common-edit-form', {
                        address: data.display_name
                    });
                })
                .catch(() => {
                    layer.msg('地址解析失败');
                });
        }

        // 2. 点击地图选点
        map.on('click', function (e) {
            setPoint(e.latlng.lat, e.latlng.lng);
            reverseAddress(e.latlng.lat, e.latlng.lng)
        });
    });
</script>
</body>
</html>