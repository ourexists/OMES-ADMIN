<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <style>
        table {
            table-layout: fixed;
            word-break: break-all;
        }

        td {
            overflow: auto;
        }
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 16px;">
            <div class="layui-carousel" id="stepForm" lay-filter="stepForm">
                <div carousel-item>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="line-edit-form"
                              lay-filter="line-edit-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="common.order.code"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="selfCode" autocomplete="off"
                                               class="layui-input lay-unable-edit era-detail-disabled"
                                               lang-i18n="common.placeholder">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="common.tenantId"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="tenantId" autocomplete="off"
                                               class="layui-input era-detail-disabled" lang-i18n="common.placeholder">
                                    </div>
                                </div>

                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="bom.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="productName" autocomplete="off" lay-verify="required"
                                               class="layui-input" lang-i18n="common.placeholder" disabled>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="bom.code"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="productCode" autocomplete="off" lay-verify="required"
                                               class="layui-input" lang-i18n="common.placeholder" disabled>
                                    </div>
                                </div>
                                <div class="layui-inline era-detail-hidden">
                                    <button type="button" id="form-select-bom-btn"
                                            class="layui-btn layui-btn-primary layui-border-blue "
                                            lang-i18n="select.bom"></button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mo.num"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="num" id="num" autocomplete="off" lay-verify="required"
                                               class="layui-input era-detail-disabled" lang-i18n="common.placeholder"
                                               onKeyUp="this.value = input_limit_int(this.value)">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="mo.execTime"></label>
                                    <div class="layui-input-inline layui-input-wrap">
                                        <div class="layui-input-prefix">
                                            <i class="layui-icon layui-icon-date"></i>
                                        </div>
                                        <input type="text" class="layui-input" id="execTime" name="execTime"
                                               lay-verify="required">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-inline" id="weight-input">
                                    <label class="layui-form-label" lang-i18n="mo.weight"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="weight" id="weight" autocomplete="off"
                                               lay-verify="required"
                                               class="layui-input era-detail-disabled" lang-i18n="common.placeholder"
                                               onKeyUp="this.value = input_limit_float(this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <table class="layui-hide" id="tb-line-detail"></table>
                            </div>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button class="layui-btn" id="formStep" lay-submit lay-filter="formStep"
                                            lang-i18n="common.step.next">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="devg-form"
                              lay-filter="devg-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="devg.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="devgName" autocomplete="off" placeholder=""
                                               disabled class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline" style="display:none">
                                    <div class="layui-input-block">
                                        <input type="text" name="devgId" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline era-detail-hidden">
                                    <button type="button" id="form-select-devg-btn"
                                            class="layui-btn layui-btn-primary layui-border-blue "
                                            lang-i18n="select.devg"></button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <table class="layui-hide" id="tb-devg-detail"></table>
                            </div>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn pre"
                                            lang-i18n="common.step.last"></button>
                                    <button class="layui-btn" lay-submit lay-filter="formStep2"
                                            lang-i18n="common.step.next">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <form class="layui-form layui-form-pane" action="" id="tf-form"
                              lay-filter="tf-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label" lang-i18n="line.name"></label>
                                    <div class="layui-input-block">
                                        <input type="text" name="line" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline" style="display:none">
                                    <div class="layui-input-block">
                                        <input type="text" name="lineCode" autocomplete="off" placeholder="" disabled
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline era-detail-hidden">
                                    <button type="button" id="form-select-line-btn"
                                            class="layui-btn layui-btn-primary layui-border-blue "
                                            lang-i18n="select.line"></button>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <table class="layui-hide" id="tb-tf-detail"></table>
                            </div>
                            <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 10%">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn pre"
                                            lang-i18n="common.step.last"></button>
                                    <button class="layui-btn" lay-submit lay-filter="formStep3"
                                            lang-i18n="common.complete">
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div style="padding: 16px;">
                        <div style="text-align: center;margin-top: 90px;">
                            <i class="layui-icon layui-circle"
                               style="color: white;font-size:30px;font-weight:bold;background: #52C41A;padding: 20px;line-height: 80px;">&#xe605;</i>
                            <div style="font-size: 24px;color: #333;font-weight: 500;margin-top: 30px;"
                                 lang-i18n="mo.create.success">
                            </div>
                        </div>
                        <div style="text-align: center;margin-top: 50px;">
                            <button class="layui-btn layui-btn-primary" onclick="closeWindow()">close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="bom-toolbar">
    <div class="layui-btn-container" style="font-weight: bold;text-align: center;">
        {{ i18np.prop('menu.bom') }}
    </div>
</script>
<script th:inline="none">
    var current_row_data = {};
    var details;
    var tfDatas;
    var table;
    var form;
    layui.use(["form", "layer", "table", 'step', 'laydate'], function () {
        form = layui.form;
        table = layui.table;
        var step = layui.step,
            laydate = layui.laydate;

        let page_type = layui.url().search.page_type;
        let id = layui.url().search.id;

        $('#weight-input').hide();
        if (id != null) {
            current_row_data.id = id;
            var param = {
                "id": current_row_data.id
            }
            get(router.mo_id, param, function (result) {
                current_row_data = result;
                details = result.detailDtoList;
                form.val("line-edit-form", {
                    "productName": result.productName,
                    "selfCode": result.selfCode,
                    "productCode": result.productCode,
                    "num": result.num,
                    "weight": result.weight,
                    "tenantId": result.tenantId,
                    // "execTime": result.execTime
                });
                reloadTb();
            })
            if (current_row_data.selfCode !== "") {
                $(".lay-unable-edit").attr("disabled", "block");
            }
        } else {
            form.val("line-edit-form", {
                "productName": "",
                "selfCode": "",
                "productCode": "",
                "num": 1,
                "weight": 0,
                "tenantId": "0"
            });
            current_row_data = {};
            details = [];
        }

        laydate.render({
            elem: '#execTime',
            type: 'datetime',
            fullPanel: true,
            lang: localStorage.getItem("language")
        });

        step.render({
            elem: '#stepForm',
            filter: 'stepForm',
            width: '100%', //设置容器宽度
            stepWidth: '750px',
            height: '500px',
            stepItems: [{
                title: i18np.prop('mo.base')
            }, {
                title: i18np.prop('devg.name')
            }, {
                title: i18np.prop('line.name')
            }, {
                title: i18np.prop('common.complete')
            }]
        });


        var page_params = {
            default_param: {
                cols: [[
                    {field: 'matName', title: i18np.prop("material.name")},
                    {field: 'matCode', title: i18np.prop("material.code")},
                    // {field: 'attribute', title: i18np.prop("bomd.attribute")},
                    // {field: 'matScale', title: i18np.prop("common.scale")},
                    {
                        field: 'matNum',
                        title: i18np.prop("material.num"),
                        edit: 'text',
                        style: 'color: red;'
                    },

                    {
                        field: 'priority',
                        title: i18np.prop("common.priority"),
                        edit: 'text',
                        style: 'color: red;'
                    }
                ]]
            },
            detail_param: {
                cols: [[
                    {field: 'matName', title: i18np.prop("material.name")},
                    {field: 'matCode', title: i18np.prop("material.code")},
                    // {field: 'attribute', title: i18np.prop("bomd.attribute")},
                    // {field: 'matScale', title: i18np.prop("common.scale")},
                    {field: 'matNum', title: i18np.prop("material.num")},
                    {field: 'priority', title: i18np.prop("common.priority")}
                ]]
            }
        }
        var page = page_params.default_param
        if (page_type === '1') {
            $('.layui-input').attr("disabled", "block");
            $('.era-detail-hidden').hide();
            page = page_params.detail_param;
        }

        table.render({
            elem: '#tb-line-detail',
            defaultToolbar: '',
            toolbar: '#bom-toolbar',
            css: [ // 设置单元格样式
                // 取消默认的溢出隐藏，并设置适当高度
                '.layui-table-cell{height: 50px; line-height: 40px;}'
            ].join(''),
            cols: page.cols,
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
            done: function () {
                layui.$(document).on('focus', 'td[data-field$="matNum"] .layui-table-edit', function () {
                    layui.$(this).attr("onKeyUp", "this.value=input_limit_float(this.value)");
                });
                layui.$(document).on('blur', 'td[data-field$="matNum"] .layui-table-edit', function () {
                    calcDetails();
                    reloadTb();
                });
                layui.$(document).on('focus', 'td[data-field$="priority"] .layui-table-edit', function () {
                    layui.$(this).attr("onKeyUp", "this.value=input_limit_int(this.value)")
                });
            }
        });

        table.render({
            elem: '#tb-devg-detail',
            defaultToolbar: '',
            // toolbar: '#bom-toolbar',
            css: [ // 设置单元格样式
                // 取消默认的溢出隐藏，并设置适当高度
                '.layui-table-cell{height: 50px; line-height: 40px;}'
            ].join(''),
            cols: [[
                {field: 'matName', title: i18np.prop("material.name")},
                {field: 'matCode', title: i18np.prop("material.code")},
                {field: 'matNum', title: i18np.prop("material.num")},
                {field: 'devNo', title: i18np.prop("dev.code")},
                {field: 'devName', title: i18np.prop("dev.name")},
                {field: 'priority', title: i18np.prop("common.priority")}
            ]],
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
        });

        table.render({
            elem: '#tb-tf-detail',
            defaultToolbar: '',
            cols: [[
                {type: 'checkbox', title: '', fixed: true}, // 单选框
                {field: 'LAY_INDEX', title: 'NO'},
                {field: 'selfCode', title: i18np.prop('mps.tf.code')},
                {field: 'name', title: i18np.prop('mps.tf.name')},
                {field: 'property', title: i18np.prop("mps.tf.property")},
                {field: 'duration', title: i18np.prop("mps.tf.duration")},
                {field: 'temperature', title: i18np.prop("mps.tf.temperature")},
                {field: 'mapDb', title: i18np.prop("mps.tf.mapDb")},
                {field: 'mapOffset', title: i18np.prop("mps.tf.offset")},
            ]],
            skin: 'line',
            page: false, // 是否显示分页
            height: "400px",
            loading: false,
        })
        ;

        $('#form-select-bom-btn').click(function () {
            openWindow("select.bom", "/view/bom_tree?page_type=1", ['95%', '80%']);
        })

        $('#form-select-line-btn').click(function () {
            openWindow("select.line", "/view/line_tables?page_type=2", ['95%', '80%']);
        })

        $('#form-select-devg-btn').click(function () {
            openWindow("select.devg", "/view/devg_tables?page_type=2", ['95%', '80%']);
        })

        $("#weight").on('blur', function () {
            calcDetails();
            reloadTb();
        })

        form.on('submit(formStep)', function (data) {
            current_row_data.productName = data.field.productName;
            current_row_data.selfCode = data.field.selfCode;
            current_row_data.productCode = data.field.productCode;
            current_row_data.num = data.field.num;
            current_row_data.tenantId = data.field.tenantId;
            current_row_data.detailDtoList = details;
            current_row_data.execTime = data.field.execTime;
            step.next('#stepForm');
            reloadDevgTb();
            return false;
        });
        form.on('submit(formStep2)', function (data) {
            current_row_data.devgId = data.field.devgId;
            step.next('#stepForm');
            return false;
        });

        form.on('submit(formStep3)', function (data) {
            current_row_data.lineCode = data.field.lineCode;
            post(router.mo_edit, current_row_data, function () {
                parent.reloadTb();
                step.next('#stepForm');
            });
            return false;
        });

        $('.pre').click(function () {
            step.pre('#stepForm');
        });

        $('.next').click(function () {
            step.next('#stepForm');
        });
    });

    function reloadTb() {
        table.reload('tb-line-detail', {
            data: details
        })
    }

    function reloadDevgTb() {
        table.reload('tb-devg-detail', {
            data: details
        })
    }

    function calcDetails() {
        var data = form.val("line-edit-form");
        let weight = data.weight;
        if (weight == null) {
            weight = 0;
        }

        let totalWeight = 0;
        layui.each(details, function (i, item) {
            if (item.priority == null) {
                item.priority = 0;
            }
            if (current_row_data.productType === 1) {
                if (item.matScale != null) {
                    item.matNum = weight * item.matScale / 100;
                } else {
                    item.matNum = 0;
                }
            } else {
                item.matNum = item.matScale;
                item.matScale = 0;
                totalWeight += item.matNum;
            }
        })
        if (current_row_data.productType === 1) {
            $('#weight-input').show();
        } else {
            form.val("line-edit-form", {
                "weight": totalWeight,
            });
            $('#weight-input').hide();
        }
    }

    function selectBom(data) {
        const param = {
            "id": data.id
        };
        get(router.bom_id, param, function (result) {
            current_row_data.productId = result.id;
            current_row_data.productCode = result.selfCode;
            current_row_data.productName = result.name;
            current_row_data.productType = result.type;
            details = result.details;
            form.val("line-edit-form", {
                "productCode": result.selfCode,
                "productName": result.name
            });
            //百分比类型清单
            calcDetails();
            reloadTb();
        })
    }

    function selectLine(data) {
        form.val("tf-form", {
            "line": data.name,
            "lineCode": data.selfCode
        });
        var param = {
            "lineId": data.id
        }
        get(router.tf_lineId, param, function (result) {
            tfDatas = result;
            table.reload('tb-tf-detail', {
                data: tfDatas
            })
        })
    }

    function selectDevg(data) {
        form.val("devg-form", {
            "devgName": data.name,
            "devgId": data.id
        });
        var param = {
            "dgId": data.id
        }
        get(router.dev_dgId, param, function (result) {
            $.each(details, function (index, value) {
                $.each(result, function (i, d) {
                    if (value.matCode === d.matCode) {
                        value.devNo = d.selfCode;
                        value.devName = d.name;
                        value.dgCode = data.selfCode;
                        value.dgName = data.name;
                    }
                })
            });
            reloadDevgTb();
        })
    }
</script>
</body>
</html>