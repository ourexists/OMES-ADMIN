<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <div class="layui-col-sm12 layui-col-md4 layui-col-lg3">
        <div class="layui-card">
            <div class="layui-card-body mini-bar" id="ltTree">
                <div class="layui-btn-container" id="lef_tree_opera">
                    <a class="layui-btn layui-btn-sm layui-btn-primary" lay-on="addroot">
                        <i class="layui-icon layui-icon-add-1"></i>
                    </a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary" lay-on="reload">
                        <i class="layui-icon layui-icon-refresh"></i>
                    </a>
                </div>
                <div class="layui-inline">
                    <input type="text" id="tree_name" class="layui-input" autocomplete="off"/>
                </div>
                <a class="layui-btn layui-btn-primary" id="tree_query">
                    <i class="layui-icon layui-icon-search"></i>
                </a>
                <div id="left-tree"></div>
            </div>
        </div>
    </div>
    <div class="layui-col-sm12 layui-col-md9 layui-col-lg9" style="padding: 15px;">
        <!--        <form class="layui-form layui-row layui-col-space16">-->
        <!--            <div class="layui-col-md4">-->
        <!--                <div class="layui-input-wrap">-->
        <!--                    <div class="layui-input-prefix">-->
        <!--                        <i class="layui-icon layui-icon-auz"></i>-->
        <!--                    </div>-->
        <!--                    <input type="text" name="accName" id="accName" value="" class="layui-input"-->
        <!--                           lay-affix="clear" lang-i18n="account.accName">-->
        <!--                </div>-->
        <!--            </div>-->
        <!--            <div class="layui-col-md4">-->
        <!--                <div class="layui-input-wrap">-->
        <!--                    <div class="layui-input-prefix">-->
        <!--                        <i class="layui-icon layui-icon-auz"></i>-->
        <!--                    </div>-->
        <!--                    <input type="text" name="mobile" id="mobile" value="" class="layui-input"-->
        <!--                           lay-affix="clear" lang-i18n="account.mobile">-->
        <!--                </div>-->
        <!--            </div>-->
        <!--            <div class="layui-btn-container layui-col-xs12">-->
        <!--                <button class="layui-btn" lay-submit lay-filter="tb-common-search" lang-i18n="common.search">-->
        <!--                    Search-->
        <!--                </button>-->
        <!--                <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.clear">Clear</button>-->
        <!--            </div>-->
        <!--        </form>-->
        <table class="layui-hide" id="tb-common"></table>
    </div>
</div>

<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="edit">
            <i class="layui-icon layui-icon-edit"></i>
        </a>
        <a class="layui-btn layui-btn-xs  layui-btn-primary layui-bg-red" lay-event="del">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
        <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-select-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="select">
            <i class="layui-icon layui-icon-ok"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
        </a>
    </div>
</script>

<script th:inline="none">
    var current_row_data;
    var current_tree_node;
    var selected_tree_node;
    var treeTable;
    var tree;

    layui.use(function () {
        treeTable = layui.treeTable;
        tree = layui.tree;
        var form = layui.form;
        var layer = layui.layer;
        var util = layui.util;

        let view_operate = {
            'tbDefaultToolbar': ['filter'],
            'tbToolbar': '#tb-toolbar',
            'tbCols': [[
                {type: 'checkbox', title: '', fixed: true},
                {field: 'code', title: i18np.prop('permission.code'), width: 80, fixed: 'left'},
                {field: 'name', title: i18np.prop('permission.name'), width: 160, fixed: 'left'},
                {field: 'typeEnum', title: i18np.prop('permission.type')},
                {field: 'strategyEnum', title: i18np.prop('permission.strategy')},
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 150,
                    minWidth: 100,
                    templet: '#tb-tool'
                }
            ]]
        }

        get(router.platform_all, null, function (result) {
            tree.render({
                elem: '#left-tree',
                data: result,
                onlyIconControl: true,  // 是否仅允许节点左侧图标控制展开收缩
                id: 'left-tree',
                edit: view_operate.treeEdit,
                extEdit: true,
                customName: { // 自定义 data 字段名 --- 2.8.14+
                    title: 'name',
                    field: 'code'
                },
                click: function (obj) {
                    $(".layui-tree-set").removeClass('layui-tree-set-active');
                    obj.elem.addClass('layui-tree-set-active');
                    //获取当前点击的节点数据
                    selected_tree_node = obj.data;
                    reloadTb();
                },
                operate: function (obj) {
                    var type = obj.type; // 得到操作类型：add、edit、del
                    var new_tree_node;
                    // Ajax 操作
                    if (type === 'update') { // 修改节点
                        current_tree_node = obj.data;
                        openWindow('common.edit', '/view/platform_form_edit', ['50%', '30%'], function () {
                            return new_tree_node;
                        })
                        return null;
                    } else if (type === 'del') { // 删除节点
                        delTreeNode(router.platform_del, [obj.data.id], null, reloadTree);
                    }
                }
            });
        }, function (code, msg) {
            alert("请重试");
        })


        // 创建表格实例
        treeTable.render({
            elem: '#tb-common',
            toolbar: view_operate.tbToolbar,
            defaultToolbar: view_operate.tbDefaultToolbar,
            cols: view_operate.tbCols,
            tree: {},
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "data": res.data,
                };
            },
            page: false,
            maxHeight: '501px',
        });
        // 工具栏事件
        treeTable.on('toolbar(tb-common)', function (obj) {
            if (selected_tree_node == null) {
                layer.msg(i18np.prop("bomc.msg.select"));
                return;
            }
            var id = obj.config.id;
            var checkStatus = treeTable.checkStatus(id);
            switch (obj.event) {
                case 'getCheckData':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    var getData = treeTable.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
                case 'add':
                    current_row_data = null;
                    openWindow('common.add', '/view/permission_form_edit', ['80%', '60%']);
                    break;
            }
        });

        // 触发单元格工具事件
        treeTable.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'edit') {
                current_row_data = data;
                openWindow('common.edit', '/view/permission_form_edit', ['80%', '60%']);
            } else if (obj.event === 'del') {
                layer.confirm(i18np.prop('common.msg.delete.sure'),
                    {
                        btn: [i18np.prop('common.msg.confirm'), i18np.prop('common.msg.cancel')]
                    }, function (index, layero) {
                        layer.close(index);
                        const param = {
                            "id": data.id
                        };
                        get(router.permission_del, param, function () {
                            reloadTb();
                        })
                    }, function () {
                        layer.close(index);
                    }
                );
            } else if (obj.event === 'add') {
                current_row_data = null;
                openWindow('common.add.node', '/view/permission_form_edit?pcode=' + data.code, ['80%', '60%']);
            }
        });
        // // table 滚动时移除内部弹出的元素
        // var tableInst = treeTable.getOptions('tb-common');
        // tableInst.elem.next().find('.layui-table-main').on('scroll', function () {
        //     dropdown.close('dropdown-table-tool');
        // });

        // 搜索提交
        form.on('submit(tb-common-search)', function (data) {
            if (selected_tree_node !== null) {
                reloadTb();
            }
            return false; // 阻止默认 form 跳转
        });

        $('#tree_query').click(function () {
            var name = $("#tree_name").val(); //搜索值
            var elem = $("#left-tree").find('.layui-tree-txt').css('color', ''); //搜索文本与设置默认颜色
            if (!name) {
                return; //无搜索值返回
            }
            elem.filter(':contains(' + name + ')').css('color', '#FFB800'); //搜索文本并设置标志颜色
            elem.parents('.layui-tree-pack').prev().find('.layui-tree-iconClick').click(); //展开选项
        });

        util.event('lay-on', {
            addroot: function (othis) {
                current_tree_node = {};
                openWindow('common.add', '/view/platform_form_edit', ['50%', '30%']);
            },
            reload: function () {
                reloadTree();
            }
        });
    });

    function reloadTb() {
        get(router.permission_in_platform, {
            platform: selected_tree_node.code
        }, function (res) {
            treeTable.reloadData('tb-common', {
                data: res
            })
        })
    }

    function reloadTree() {
        get(router.platform_all, null, function (result) {
            tree.reload("left-tree", {data: result});
        })
    }
</script>
</body>
</html>