<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <table class="layui-hide" id="tb-common"></table>
</div>
<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs " lay-event="removeQue">{{ i18np.prop('mps.queue.remove') }}</a>
        {{# if (d.LAY_INDEX!==0) { }}
        <a class="layui-btn layui-btn-xs " lay-event="jumpQue">{{ i18np.prop('mps.queue.jump') }}</a>
        {{# } }}
    </div>
</script>
<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="refresh">
            <i class="layui-icon layui-icon-refresh"></i>
        </a>
        <span style="color:red;font-style: italic">{{ i18np.prop('common.msg.sort') }}</span>
    </div>
</script>
<script th:inline="none">
    layui.use(['table', 'layer', 'util', 'soulTable'], function () {
        var layer = layui.layer,
            soulTable = layui.soulTable,
            table = layui.table;

        // 创建表格实例
        table.render({
            elem: '#tb-common',
            url: initRequestUrl(router.mps_page),
            method: 'POST',
            headers: getCommonHeader(),
            contentType: 'application/json',
            loading: false,
            toolbar: '#tb-toolbar',
            defaultToolbar: [],
            cols: [[
                {field: 'LAY_INDEX', title: 'NO'},
                {field: 'id', title: 'ID'},
                {
                    field: 'line',
                    title: i18np.prop("line.name"),
                    templet: function (d) {
                        return d.lineVo == null ? '' : d.lineVo.name
                    }
                },
                {field: 'moCode', title: i18np.prop('mo.code')},
                {
                    field: 'productName', title: i18np.prop('bom.name'), templet: function (d) {
                        return d.moDto == null ? '' : d.moDto.productName;
                    }
                },
                {
                    field: 'productCode', title: i18np.prop('bom.code'), templet: function (d) {
                        return d.moDto == null ? '' : d.moDto.productCode;
                    }
                },
                // {field: 'sequence', title: i18np.prop('mps.sequence')},
                {field: 'batch', title: i18np.prop("mps.batch")},
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#tb-tool'
                }
            ]],
            rowDrag: {
                done: function (obj) {
                    var pre = obj.cache[obj.newIndex - 1];
                    var post = obj.cache[obj.newIndex + 1];
                    var param = {
                        'pre': pre == null ? null : pre.id,
                        'post': post == null ? null : post.id,
                        'current': obj.row.id
                    }
                    window.post(router.mps_changePriority, param, function (result) {
                        table.reloadData('tb-common');
                        parent.reloadTb();
                    })
                }
            },
            done: function () {
                soulTable.render(this);
            },
            where: {
                queryMO: true,
                queryLine: true,
                status: 1,
                requirePage: false,
                prioritySort: true
            },
            request: {
                pageName: 'page',
                limitName: 'pageSize'
            },
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "count": res.pagination.total,
                    "data": res.data,
                };
            },
            page: false,
            height: 'full'
            // maxHeight: 600
        });
        table.on('toolbar(tb-common)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'refresh':
                    table.reloadData('tb-common')
                    return
                default:
                    break;
            }
        })
        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'removeQue') {
                var param = {
                    'id': data.id,
                    'type': 0
                }
                post(router.mps_remove_que, param, function (result) {
                    table.reloadData('tb-common');
                    parent.reloadTb();
                }, function (code, msg) {
                    layer.msg(msg);
                });
            } else if (obj.event === 'jumpQue') {
                var param = {
                    'id': data.id
                }
                post(router.mps_jump_que, param, function (result) {
                    table.reloadData('tb-common');
                }, function (code, msg) {
                    layer.msg(msg);
                });
            }
        });
    })
</script>
</body>
</html>