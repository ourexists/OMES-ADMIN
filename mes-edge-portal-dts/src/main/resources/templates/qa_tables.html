<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <link rel="stylesheet" href="../static/layui/css/custom.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <form class="layui-form layui-row layui-col-space16" id="query-form" lay-filter="query-form">
        <div class="layui-col-md4">
            <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-auz"></i>
                </div>
                <input type="text" name="moCode" id="moCode" value="" placeholder=""
                       class="layui-input"
                       lay-affix="clear" lang-i18n="mo.code">
            </div>
        </div>
        <div class="layui-btn-container layui-col-xs12">
            <button class="layui-btn" lay-submit lay-filter="tb-common-search" lang-i18n="common.search">
                Search
            </button>
            <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.clear">Clear</button>
        </div>
    </form>
    <table class="layui-hide" id="tb-common"></table>
</div>

<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        {{# if(d.result===0){ }}
        <a class="layui-btn layui-btn-xs layui-bg" lay-event="qaAdd">{{ i18np.prop('manual.start') }}</a>
        {{# } }}
        <a class="layui-btn layui-btn-xs layui-bg-orange" lay-event="detail">{{ i18np.prop('common.detail') }}</a>
    </div>
</script>

<script th:inline="javascript">
    var table;
    var current_row_data = {};
    layui.use(['form', 'table', 'layer', 'util'], function () {
        table = layui.table;
        var form = layui.form,
            layer = layui.layer;

        let moCode = layui.url().search.moCode;
        form.val("query-form", {
            'moCode': moCode
        })

        get(router.mps_status, null, function (result) {
            $.each(result, function (index, item) {
                //option  第一个参数是页面显示的值，第二个参数是传递到后台的值
                $('#status').append(new Option(item.name, item.id));//往下拉菜单里添加元素
                form.render();
            })
        })


        // 创建表格实例
        table.render({
            elem: '#tb-common',
            url: initRequestUrl(router.qa_page),
            headers: getCommonHeader(),
            method: 'POST',
            contentType: 'application/json',
            loading: false,
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {type: 'checkbox', title: '', fixed: true}, // 单选框
                {field: 'id', title: 'ID'},
                {field: 'resultDesc', title: i18np.prop('manual.status')},
                {
                    field: 'moCode', title: i18np.prop('mo.code'), templet: function (r) {
                        return r.mps == null ? '' : r.mps.moCode
                    }
                },
                {
                    field: 'batch', title: i18np.prop("mps.batch"), templet: function (r) {
                        return r.mps == null ? '' : r.mps.batch
                    }
                },
                {
                    field: 'mpstf',
                    title: i18np.prop("mps.tf.name"), templet: function (d) {
                        return d.mpstf == null ? '' : d.mpstf.name
                    }
                },
                {
                    field: 'tfStartTime', title: i18np.prop('mps.tf.start_time'), templet: function (d) {
                        return d.mpstf == null ? '' : (d.mpstf.startTime == null ? '' : d.mpstf.startTime)
                    }
                },
                {
                    field: 'tfEndTime', title: i18np.prop('mps.tf.end_time'), templet: function (d) {
                        return d.mpstf == null ? '' : (d.mpstf.endTime == null ? '' : d.mpstf.endTime)
                    }
                },
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#tb-tool'
                }
            ]],
            where: {
                queryMPS: true,
                queryMPSTF: true
            },
            request: {
                pageName: 'page',
                limitName: 'pageSize'
            },
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "count": res.pagination.total,
                    "data": res.data,
                };
            },
            limit: 10,
            limits: [10, 20, 50, 100],
            page: true,
            height: 'full'
        });
        // 工具栏事件
        table.on('toolbar(tb-common)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'getCheckData':
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    var getData = table.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
            }
        });

        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'del') {
                delWindow(router.mps_del, [data.id], reloadTb);
            } else if (obj.event === 'detail') {
                parent.openIndexTab('/view/mps_form_edit?id=' + data.mpsId, 'mps_detail' + data.mpsId, i18np.prop('mps.detail') + '[' + obj.data.id + ']')
            } else if (obj.event === 'qaAdd') {
                openWindow('manual.start', '/view/qa_form_edit?id=' + data.id);
            }
        });

        // 搜索提交
        form.on('submit(tb-common-search)', function (data) {
            reloadTb();
            return false; // 阻止默认 form 跳转
        });
    })
    ;

    function reloadTb() {
        table.reloadData('tb-common', {
            page: {
                curr: 1 // 重新从第 1 页开始
            },
            where: {
                moCode: $('#moCode').val(),
                queryMPS: true,
                queryMPSTF: true
            },
        });
    }
</script>
</body>
</html>