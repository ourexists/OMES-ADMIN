<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div style="padding: 16px;">
    <form class="layui-form layui-form-pane" action="" id="common-edit-form"
          lay-filter="common-edit-form">
        <div class="layui-form-item">
            <div class="layui-inline layui-fluid">
                <label class="layui-form-label" lang-i18n="bom.name"></label>
                <div class="layui-input-block">
                    <input type="text" name="name" autocomplete="off" placeholder="" lay-verify="required"
                           class="layui-input" lang-i18n="common.placeholder">
                </div>
            </div>
            <div class="layui-inline layui-fluid">
                <label class="layui-form-label" lang-i18n="bom.code"></label>
                <div class="layui-input-block">
                    <input type="text" id="selfCode" name="selfCode" autocomplete="off" placeholder=""
                           lay-verify="required"
                           class="layui-input" lang-i18n="common.placeholder">
                </div>
            </div>

            <div class="layui-inline  layui-fluid">
                <label class="layui-form-label" lang-i18n="bom.type"></label>
                <div class="layui-input-block">
                    <select name="type" id="type">
                    </select>
                </div>
            </div>
        </div>
        <table class="layui-hide" id="tb-common-detail" high="80%"></table>
        <div class="layui-form-item" style="position: fixed; bottom: 5%; right: 5%">
            <button class="layui-btn" lay-submit lay-filter="common-edit-button"
                    lang-i18n="common.msg.confirm"></button>
            <button class="layui-btn layui-btn-primary" onclick="closeWindow()">close</button>
        </div>
    </form>
</div>
<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="del">
            <i class="layui-icon layui-icon-subtraction"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="selectMat">
            <i class="layui-icon layui-icon-addition"></i>
        </a>
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="deleteBatch">
            <i class="layui-icon layui-icon-subtraction"></i>
        </a>
        <span style="color:red;font-style: italic">* {{ i18np.prop('mps.select.mat') }}</span>
    </div>
</script>

<script th:inline="none">
    var current_row_data = parent.current_row_data;
    var details = [];
    var table;
    var attributes;
    var dropdown

    layui.use(['form', 'layer', "table"], function () {
        var form = layui.form;
        var layer = layui.layer;
        table = layui.table;

        if (current_row_data != null && current_row_data.id != null) {
            if (current_row_data.selfCode != null && current_row_data.selfCode !== "") {
                $("#selfCode").attr("disabled", "block");
            }
            var param = {
                "id": current_row_data.id
            }
            get(router.bom_id, param, function (result) {
                current_row_data = result;
                details = result.details;
                $.each(details, function (index, detail) {
                    detail.tmp_id = detail.id;
                })
                form.val("common-edit-form", {
                    "name": current_row_data.name,
                    "selfCode": current_row_data.selfCode,
                    "type": current_row_data.type,
                });
                reloadTb();
            })
        } else {
            form.val("common-edit-form", {
                "name": "",
                "selfCode": "",
                "type": 0
            });
            if (current_row_data == null) {
                current_row_data = {}
            }
        }

        get(router.bom_type, null, function (result) {
            $.each(result, function (index, item) {
                if (current_row_data != null
                    && current_row_data.attribute != null
                    && item.id === current_row_data.attribute.toString()) {
                    $('#type').append(new Option(item.name, item.id, false, true));
                } else {
                    $('#type').append(new Option(item.name, item.id));
                }
            })
            form.render();
        })
        get(router.bomd_attribute, null, function (result) {
            attributes = result;
        })

        table.render({
            elem: '#tb-common-detail',
            defaultToolbar: '',
            toolbar: '#tb-toolbar',
            css: [ // 设置单元格样式
                // 取消默认的溢出隐藏，并设置适当高度
                '.layui-table-cell{height: 50px; line-height: 40px;}',
                '.layui-table-cell select{height: 36px; padding: 0 5px;}'
            ].join(''),
            cols: [[
                {type: 'checkbox', title: '', fixed: true},
                {field: 'matName', title: i18np.prop("material.name")},
                {field: 'matCode', title: i18np.prop("material.code")},
                // {
                //     field: 'attribute',
                //     title: i18np.prop("bomd.attribute"),
                //     style: 'color: red;',
                //     templet: function (d) {
                //         var temp = '<select name="attribute" lay-filter="tb-select-attribute" lay-append-to="body">'
                //         layui.each(attributes, function (i, v) {
                //             if (v.id === d.attribute.toString()) {
                //                 temp += '<option value="' + v.id + '" selected>' + v.name + '</option>';
                //             } else {
                //                 temp += '<option value="' + v.id + '">' + v.name + '</option>';
                //             }
                //         })
                //         temp += '</select>';
                //         return temp;
                //     }
                // },
                {
                    field: 'matScale',
                    title: i18np.prop("bom.per"),
                    edit: 'text',
                    style: 'color: red;'
                },
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#tb-tool'
                }
            ]],
            resize: true,
            loading: false,
            page: false, // 是否显示分页
            height: "full",
            done: function (res, curr, count) {
                var options = this;
                // 获取当前行数据 - 自定义方法
                table.getRowData = function (tableId, elem) {
                    var index = $(elem).closest('tr').data('index');
                    return table.cache[tableId][index] || {};
                };

                form.on('select(tb-select-attribute)', function (obj) {
                    var value = obj.value; // 获取选中项 value
                    // 获取当前行数据(如 id 等字段，以作为数据修改的索引)
                    var data = table.getRowData(options.id, obj.elem);
                    // 更新数据中对应的字段
                    data.attribute = value;
                });
                layui.$(document).on('focus', 'td[data-field$="matScale"] .layui-table-edit', function () {
                    layui.$(this).attr("onKeyUp", "this.value=input_limit_float(this.value)")
                });

            }
        });


        table.on('tool(tb-common-detail)', function (obj) {
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'del') {
                let r = [];
                r.push(data);
                removeTbData(r);
            }
        });

        table.on('toolbar(tb-common-detail)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            switch (obj.event) {
                case 'deleteBatch':
                    const data = checkStatus.data;
                    if (data.length === 0) {
                        layer.msg(i18np.prop('common.msg.least.one'));
                        return false;
                    }
                    removeTbData(data);
                    break;
                case 'selectMat':
                    openWindow("mps.select.mat", "/view/material_tables?page_type=3", ['95%', '80%']);
            }
        });
        form.on('submit(common-edit-button)', function (data) {
            current_row_data.selfCode = data.field.selfCode;
            current_row_data.name = data.field.name;
            current_row_data.type = data.field.type;
            current_row_data.details = details;
            if (details.length === 0) {
                layer.msg(i18np.prop('common.msg.detail.lock'));
                return false;
            }
            post(router.bom_edit, current_row_data, function () {
                closeWindow();
                parent.reloadTb();
            }, function (code, msg) {
                layer.alert(msg, {
                    title: "error"
                });
            })
        })
    });

    function addTbData(items) {
        var timestamp = Date.now();
        $.each(items, function (index, value) {
            var current = {
                "matName": value.name,
                "matCode": value.selfCode,
                "matId": value.id,
                "tmp_id": timestamp + "_" + index,
                "matScale": 0,
                "attribute": 0
            };
            details.push(current);
        })
        reloadTb();
    }

    function reloadTb() {
        table.reload('tb-common-detail', {
            data: details,
        })
    }

    function removeTbData(data) {
        for (let i = 0; i < data.length; i++) {
            if (data[i].tmp_id != null) {
                for (let j = 0; j < details.length; j++) {
                    if (details[j].tmp_id != null && details[j].tmp_id === data[i].tmp_id) {
                        details.splice(j, 1);
                        break;
                    }
                }
            }
        }
        reloadTb();
    }
</script>
</body>
</html>