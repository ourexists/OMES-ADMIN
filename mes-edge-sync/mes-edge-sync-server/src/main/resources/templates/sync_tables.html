<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
    <script src="../static/sync/router.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <form class="layui-form layui-row layui-col-space16">
        <div class="layui-col-md4">
            <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-auz"></i>
                </div>
                <select name="syncTx" id="syncTx">
                    <option value="" lang-i18n="sync.syncTx"></option>
                </select>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-auz"></i>
                </div>
                <select name="status" id="status">
                    <option value="" lang-i18n="sync.status"></option>
                </select>
            </div>
        </div>
        <div class="layui-btn-container layui-col-xs12">
            <button class="layui-btn" lay-submit lay-filter="ebs-material-search" lang-i18n="common.search">Search
            </button>
            <button type="reset" class="layui-btn layui-btn-primary" lang-i18n="common.clear">Clear</button>
        </div>
    </form>
    <table class="layui-hide" id="tb-common"></table>
</div>
<script type="text/html" id="tb-tool">
    <div class="layui-clear-space">
        {{# if (d.status !== 'end') { }}
        <a class="layui-btn layui-btn-xs" lay-event="breakpoint">{{ i18np.prop('sync.breakpoint') }}</a>
        {{# } }}
        <a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="flow">{{ i18np.prop('sync.resource') }}</a>
    </div>
</script>
<!--<script type="text/html" id="tb-toolbar">-->
<!--    <div class="layui-btn-container">-->
<!--        <button class="layui-btn layui-btn-sm" lay-event="add">{{ i18np.prop('common.add') }}</button>-->
<!--        <button class="layui-btn layui-btn-sm layui-bg-red" lay-event="deleteBatch">{{ i18np.prop('common.delete.batch')-->
<!--            }}-->
<!--        </button>-->
<!--    </div>-->
<!--</script>-->

<script th:inline="none">
    var current_row_data;
    var table
    layui.use(['form', 'table', 'dropdown', 'layer'], function () {
        table = layui.table;
        var form = layui.form;
        var dropdown = layui.dropdown;

        var page_params = {
            default_param: {
                cols: [[
                    {field: 'id', title: 'ID'},
                    {field: 'syncTx', title: i18np.prop('sync.syncTx')},
                    {field: 'partStartTimestamp', title: i18np.prop('sync.partStartTimestamp')},
                    {field: 'partEndTimestamp', title: i18np.prop('sync.partEndTimestamp')},
                    {field: 'status', title: i18np.prop('sync.status')},
                    {field: 'partMin', title: i18np.prop('sync.partMin')},
                    {field: 'partMax', title: i18np.prop('sync.partMax')},
                    {field: 'createdTime', title: i18np.prop('common.createdTime')},
                    {
                        fixed: 'right',
                        title: i18np.prop('common.operate'),
                        width: 200,
                        minWidth: 125,
                        templet: '#tb-tool'
                    }
                ]],
                // toolbar: '#tb-toolbar',
                defaultToolbar: ['filter', 'exports', 'print'],
            }
        }

        let page = page_params.default_param;

        get(router.sync_tx, null, function (result) {
            $.each(result, function (index, item) {
                //option  第一个参数是页面显示的值，第二个参数是传递到后台的值
                $('#syncTx').append(new Option(item.name, item.id));//往下拉菜单里添加元素
                form.render();
            })
        })

        get(router.sync_status, null, function (result) {
            $.each(result, function (index, item) {
                //option  第一个参数是页面显示的值，第二个参数是传递到后台的值
                $('#status').append(new Option(item.name, item.id));//往下拉菜单里添加元素
                form.render();
            })
        })


        // 创建表格实例
        table.render({
            elem: '#tb-common',
            url: initRequestUrl(router.sync_page),
            method: 'POST',
            contentType: 'application/json',
            headers: getCommonHeader(),
            // toolbar: page.toolbar,
            defaultToolbar: page.defaultToolbar,
            cols: page.cols,
            request: {
                pageName: 'page',
                limitName: 'pageSize'
            },
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "count": res.pagination.total,
                    "data": res.data,
                };
            },
            limit: 10,
            limits: [10, 20, 50, 100],
            page: true,
            height: 'full'
        });

        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'flow') {
                openWindow('sync.resource', '/view/sync_resource?sync_id=' + data.id)
            } else if (obj.event === 'breakpoint') {
                let msg = i18np.prop('sync.msg.breakpoint');
                if (data.status !== 'error') {
                    msg = i18np.prop('sync.alert.breakpoint');
                }
                layer.confirm(msg, function (index) {
                    get(router.sync_breakpoint, {"id": data.id}, function () {
                        reloadTb();
                        layer.close(index);
                    });
                })
            }
        });

        // table 滚动时移除内部弹出的元素
        var tableInst = table.getOptions('tb-common');
        tableInst.elem.next().find('.layui-table-main').on('scroll', function () {
            dropdown.close('dropdown-table-tool');
        });

        // 搜索提交
        form.on('submit(ebs-material-search)', function (data) {
            reloadTb();
            return false; // 阻止默认 form 跳转
        });
    });

    function reloadTb() {
        table.reloadData('tb-common', {
            page: {
                curr: 1 // 重新从第 1 页开始
            },
            where: {
                syncTx: $('#syncTx').val(),
                status: $('#status').val()
            },
        });
    }


</script>
</body>
</html>