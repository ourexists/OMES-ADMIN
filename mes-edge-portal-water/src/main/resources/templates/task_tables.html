<!--
  ~ Copyright (c) 2025. created by ourexists.https://gitee.com/ourexists
  -->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>数据表格页面</title>
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/i18n.js"></script>
    <script src="../static/js/global.js"></script>
</head>
<body>
<div class="layui-tab-content" style="padding: 15px;">
    <table class="layui-hide" id="tb-common"></table>
</div>
<script type="text/html" id="common-tool">
    <div class="layui-clear-space">
        {{# if (d.status===0) { }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="start">
            <i class="layui-icon layui-icon-play"></i>
        </a>
        <a class="layui-btn layui-btn-xs  layui-btn-primary" lay-event="edit">
            <i class="layui-icon layui-icon-edit"></i>
        </a>
        {{# } else { }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="stop">
            <i class="layui-icon layui-icon-pause"></i>
        </a>
        {{# } }}
        <a class="layui-btn layui-btn-xs  layui-btn-primary layui-bg-red" lay-event="del">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
    </div>
</script>
<script type="text/html" id="common-toolbar">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="refresh">
            <i class="layui-icon layui-icon-refresh"></i>
        </a>
        <a class="layui-btn layui-btn-sm  layui-btn-primary" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i>
        </a>
        <a class="layui-btn layui-btn-sm layui-bg-red" lay-event="deleteBatch">
            <i class="layui-icon layui-icon-delete"></i>
        </a>
    </div>
</script>
<script type="text/html" id="tb-select-tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs" lay-event="select">{{ i18np.prop('common.select') }}</a>
    </div>
</script>

<script th:inline="none">
    var table
    layui.use(['form', 'table', 'dropdown', 'layer'], function () {
        table = layui.table;
        var dropdown = layui.dropdown;

        var page = {
            cols: [[
                {type: 'checkbox', title: '', fixed: true},
                {field: 'id', title: 'ID'},
                {field: 'name', title: i18np.prop('task.name')},
                {field: 'type', title: i18np.prop('task.type')},
                {field: 'cron', title: i18np.prop('task.cron')},
                {field: 'statusDesc', title: i18np.prop('task.status')},
                {
                    fixed: 'right',
                    title: i18np.prop('common.operate'),
                    width: 200,
                    minWidth: 125,
                    templet: '#common-tool'
                }
            ]],
            toolbar: '#common-toolbar',
            defaultToolbar: ['filter', 'exports', 'print'],
        }

        // 创建表格实例
        table.render({
            elem: '#tb-common',
            url: initRequestUrl(router.task_page),
            headers: getCommonHeader(),
            method: 'POST',
            contentType: 'application/json',
            toolbar: page.toolbar,
            defaultToolbar: page.defaultToolbar,
            cols: page.cols,
            request: {
                pageName: 'page',
                limitName: 'pageSize'
            },
            response: {
                statusName: 'code', //规定返回的状态码字段为code
                statusCode: 200, //规定成功的状态码味200
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "count": res.pagination.total,
                    "data": res.data,
                };
            },
            limit: 10,
            limits: [10, 20, 50, 100],
            page: true,
            height: 'full'
        });
        // 工具栏事件
        table.on('toolbar(tb-common)', function (obj) {
            var id = obj.config.id;
            var checkStatus = table.checkStatus(id);
            var data = checkStatus.data;
            switch (obj.event) {
                case 'getCheckData':
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    layer.alert(layui.util.escape(JSON.stringify(data)));
                    break;
                case 'getData':
                    var getData = table.getData(id);
                    layer.alert(layui.util.escape(JSON.stringify(getData)));
                    break;
                case 'add':
                    openWindow('common.add', '/view/task_form_edit');
                    break;
                case 'deleteBatch':
                    if (data.length === 0) {
                        return layer.msg(i18np.prop('common.msg.least.one'));
                    }
                    var ids = [];
                    $.each(data, function (i, n) {
                        ids.push(n.id);
                    });
                    delWindow(router.task_del, ids, reloadTb);
                    break;
                case 'refresh':
                    reloadTb();
                    break;
            }
        });

        // 触发单元格工具事件
        table.on('tool(tb-common)', function (obj) { // 双击 toolDouble
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'edit') {
                openWindow('common.edit', '/view/task_form_edit?id=' + data.id);
            } else if (obj.event === 'del') {
                delWindow(router.task_del, [data.id], reloadTb);
            } else if (obj.event === 'select') {
                parent.selectMat(data);
                closeWindow();
            } else if (obj.event === 'start') {
                get(router.task_start, {'id': data.id}, function (re) {
                    reloadTb();
                })
            } else if (obj.event === 'stop') {
                get(router.task_stop, {'id': data.id}, function (re) {
                    reloadTb();
                })
            }
        });

        // table 滚动时移除内部弹出的元素
        var tableInst = table.getOptions('tb-common');
        tableInst.elem.next().find('.layui-table-main').on('scroll', function () {
            dropdown.close('dropdown-table-tool');
        });

        // // 搜索提交
        // form.on('submit(ebs-material-search)', function (data) {
        //     reloadTb();
        //     return false; // 阻止默认 form 跳转
        // });
    })
    ;

    function reloadTb() {
        table.reloadData('tb-common', {
            page: {
                curr: 1 // 重新从第 1 页开始
            },
        });
    }


</script>
</body>
</html>